---
title: R 的效能微調
description: 本文說明 R Services 的效能最佳化。
ms.prod: sql
ms.technology: machine-learning-services
ms.date: 04/15/2018
ms.topic: how-to
author: dphansen
ms.author: davidph
ms.custom: seo-lt-2019
monikerRange: '>=sql-server-2016||>=sql-server-linux-ver15||=sqlallproducts-allversions'
ms.openlocfilehash: 991f9f0ddbe58e5591a89ff16bf8455d5a5cdca4
ms.sourcegitcommit: da88320c474c1c9124574f90d549c50ee3387b4c
ms.translationtype: HT
ms.contentlocale: zh-TW
ms.lasthandoff: 07/01/2020
ms.locfileid: "85756473"
---
# <a name="performance-tuning-for-r-in-sql-server"></a>SQL Server 中 R 的效能微調
 [!INCLUDE [SQL Server](../../includes/applies-to-version/sqlserver.md)]

本文是一系列共四篇文章中的第一篇，會根據兩個案例研究來描述 R Services 的效能最佳化：

- 產品開發小組為了驗證 R 解決方案的效能概況而進行的效能測試

- Microsoft 資料科學小組針對客戶經常要求的特定機器學習案例所進行的效能最佳化。

這一系列的目標是要提供最適合用來在 SQL Server 中執行 R 作業的效能微調技術類型相關指引。

+ 這個 (第一個) 主題會提供架構概觀，以及在為資料科學工作最佳化時的一些常見問題。
+ 第二篇文章會說明特定硬體和 SQL Server 的最佳化。
+ 第三篇文章會說明 R 程式碼和資源為了運作化所進行的最佳化。
+ 第四篇文章則會詳細說明測試方法，並報告結果和結論。

**適用範圍：** SQL Server 2016 R Services、SQL Server 機器學習服務

## <a name="performance-goals-and-targeted-scenarios"></a>效能目標和標的案例

SQL Server 2016 引進了 R Services 功能以便支援由 SQL Server 來支援 R 指令碼。 當您使用這項功能時，R 執行階段會在與資料庫引擎不同的處理序中運作，但可使用會與 SQL Server 互動的伺服器資源和服務 (例如受信任的 Launchpad) 來安全地與資料庫引擎交換資料。

SQL Server 2017 則已宣佈會支援使用相同的架構來執行 Python 指令碼，並且會在未來支援其他語言。

隨著支援的版本和語言數目增加，資料庫管理員和資料庫架構設計人員就必須留意機器學習作業是否可能造成資源爭用，而且也必須能夠設定伺服器以支援新的工作負載。 雖然讓分析貼近資料可排除不安全的資料移動，但這麼做也會讓分析工作負載脫離資料科學家的膝上型電腦，而回到裝載資料的伺服器上。

機器學習的效能最佳化顯然並非一體適用。 下列常見工作可能會有非常不同的效能概況：

- 定型工作：建立和定型迴歸模型對上定型神經網路
- 使用 R 的特徵工程對上使用 T-SQL 的特徵擷取
- 對單一資料列或小型批次進行評分對上使用表格式輸入大量評分
- 在 R 中執行評分對上在預存程序中將模型部署至 SQL Server 上的生產環境
- 修改 R 程式碼以將資料傳輸量降至最低，或是移除高成本的資料轉換
- 啟用模型的自動化測試和重新定型

要選擇什麼最佳化技術取決於哪個工作對您的應用程式或使用案例至關重要，因此案例研究會同時涵蓋一般的效能秘訣，以及如何針對特定案例最佳化 (針對批次評分的最佳化) 的指引。

+ **SQL Server 中的個別最佳化選項**

    第一個效能案例研究會使用單一類型的模型，對單一資料集執行多個測試。 用來建置模型並從中建立分數的演算法是 RevoscaleR 中的 rxLinMod，但是程式碼以及基礎資料的資料表會有系統地改變，以測試每項變更的影響。

    例如，某個測試回合改變了 R 程式碼，以便可以比較使用轉換函式的特徵工程與預先計算特徵再從資料表載入特徵。 在另一個測試回合中，則針對使用標準的索引資料表與資料表中具有各種壓縮類型或新索引類型的資料，比較了兩者的模型定型效能。

+ **特定大量評分最佳化案例**

    第二個案例研究中的機器學習工作牽涉到處理針對多個職位所提交的眾多履歷表，並尋找每個職位的最佳候選人。 機器學習模型本身會公式化為二元分類問題：該模型會採用履歷表和職位描述作為輸入，然後產生每個履歷表-職位配對的可能性。 因為目標是要找到最佳人選，所以會使用使用者定義的可能性臨界值來進一步篩選，從而只挑選出優秀的配對。

    此解決方案的主要目標是要在評分期間實現低延遲。 不過，即使在評分過程中，這項工作也需要會耗費大量運算費用，因為每個新的職位都必須在合理的時間範圍內，與數百萬封履歷表進行比對。 此外，特徵工程步驟也會針對每封履歷表或每個職位產生超過 2000 個特徵，因此會成為顯著的效能瓶頸。

建議您檢閱第一個案例研究的所有結果，以判斷哪些技術適用於您的解決方案，並權衡其潛在影響。

然後，檢閱評分最佳化案例研究的結果，以了解建立者如何運用不同技術並將伺服器最佳化以支援特定工作負載。

## <a name="performance-optimization-process"></a>效能最佳化流程

要設定和微調效能，就必須建立穩固的基礎，從而能夠將針對特定工作負載所設計的最佳化分為不同層級：

- 選擇適當的伺服器來裝載分析。 通常會建議使用報告次要、資料倉儲或其他已用於其他保告或分析的伺服器。 不過，在混合式交易分析處理 (HTAP) 解決方案中，操作資料可用來作為 R 的輸入，以實現快速評分。

- 設定 SQL Server 執行個體，以在適當層級平衡資料庫引擎作業和 R 或 Python 指令碼的執行。 這可能包括變更 SQL Server 的記憶體和 CPU 使用量預設值、NUMA 和處理器親和性設定，以及資源群組的建立。

- 將伺服器電腦最佳化，以支援有效率地使用外部指令碼。 這可能包括增加用於外部指令碼執行的帳戶數目、啟用套件管理，以及將使用者指派給相關的安全性角色。

- 在 SQL Server 中套用資料儲存和傳輸專屬的最佳化，包括編制索引和統計資料策略、查詢設計和查詢最佳化，以及用於機器學習的資料表設計。 您也可以分析資料來源和資料傳輸方法，或修改 ETL 流程以將特徵擷取最佳化。

- 微調分析模型以避免效率不佳。 可能的最佳化範圍取決於 R 程式碼的複雜度，以及您所使用的套件和資料。 主要工作包括消除成本高昂的資料轉換，或將資料準備或特徵工程工作從 R 或 Python 卸載至 ETL 流程或 SQL。 您也可以重構指令碼、排除內嵌套件安裝、將 R 程式碼分成個別程序來進行定型、評分和評估，或將程式碼簡化為預存程序以便更有效率地運作。

## <a name="articles-in-this-series"></a>此系列中的文章

+ [SQL Server 中 R 的效能微調 - 硬體](../r/sql-server-configuration-r-services.md)

    提供指引來讓您了解如何設定 [!INCLUDE[ssNoVersion_md](../../includes/ssnoversion-md.md)] 安裝所在的硬體，以及如何設定 SQL Server 執行個體以便更好地支援外部指令碼。 此文章特別適用於**資料庫管理員**。

+ [SQL Server 中 R 的效能微調 - 程式碼和資料最佳化](../r/r-and-data-optimization-r-services.md)

    提供特定秘訣來讓您了解如何將外部指令碼最佳化以避免已知的問題。 此文章最適合**資料科學家**閱讀。

    > [!NOTE]
    > 雖然本節中的許多資訊大致都適用於 R，但其中有某些資訊是 RevoScaleR 分析函式所專屬的。 **revoscalepy** 和其他受支援的 Python 程式庫則沒有詳細的效能指導方針。
    >

+ [SQL Server 中 R 的效能微調 - 方法和結果](../r/performance-case-study-r-services.md)

    摘要說明兩個案例研究使用了哪些資料、如何測試效能，以及最佳化對結果的影響。
