---
title: SQL Server R Services 效能微調
ms.prod: sql
ms.technology: machine-learning
ms.date: 04/15/2018
ms.topic: conceptual
author: dphansen
ms.author: davidph
ms.openlocfilehash: 49b96bf2c3381f3b0d44ba0b0192fbe0c0df4a2f
ms.sourcegitcommit: c1382268152585aa77688162d2286798fd8a06bb
ms.translationtype: MT
ms.contentlocale: zh-TW
ms.lasthandoff: 07/19/2019
ms.locfileid: "68344862"
---
# <a name="performance-tuning-for-r-in-sql-server"></a>SQL Server 中 R 的效能微調
[!INCLUDE[appliesto-ss-xxxx-xxxx-xxx-md-winonly](../../includes/appliesto-ss-xxxx-xxxx-xxx-md-winonly.md)]

本文是一系列四篇文章中的第一篇, 根據兩個個案研究來描述 R 服務的效能優化:

- 產品開發小組執行的效能測試, 用來驗證 R 解決方案的效能設定檔

- Microsoft 資料科學小組的效能優化, 適用于客戶經常要求的特定機器學習案例。

此系列的目標是要提供有關在 SQL Server 中執行 R 作業最有用的效能微調技術類型的指引。

+ 此 (第一個) 主題提供架構的總覽, 以及優化資料科學工作時的一些常見問題。
+ 第二篇文章涵蓋特定硬體和 SQL Server 優化。
+ 第三篇文章涵蓋運算化 R 程式碼和資源的優化。
+ 第四篇文章詳細說明測試方法, 並報告結果和結論。

**適用於：** SQL Server 2016 R Services, SQL Server 2017 Machine Learning 服務

## <a name="performance-goals-and-targeted-scenarios"></a>效能目標和目標案例

R Services 功能是在 SQL Server 2016 中引進, 藉由 SQL Server 來支援 R 腳本的執行。 當您使用這項功能時, R 執行時間會與資料庫引擎在不同的進程中運作, 但會使用與 SQL Server 互動的伺服器資源和服務 (例如受信任的啟動列), 以安全地與 database engine 交換資料。

在 SQL Server 2017 中, 已宣佈支援使用相同的架構執行 Python 腳本, 並在未來提供其他語言。

當支援的版本和語言數目增加時, 資料庫管理員和資料庫架構設計人員必須留意機器學習作業造成的資源爭用可能性, 而且能夠設定伺服器以支援新的工作負載。 雖然讓分析接近資料會排除不安全的資料移動, 但它也會將分析工作負載從資料科學家的膝上型電腦移至裝載資料的伺服器上。

機器學習服務的效能優化, 顯然並非一體適用。 下列常見工作可能會有非常不同的效能設定檔:

- 定型工作: 建立和定型回歸模型與訓練類神經網路
- 使用 R 的特徵工程設計與使用 T-sql 的功能解壓縮
- 使用表格式輸入對單一資料列或小型批次進行評分, 與大量計分
- 在 R 中執行計分和將模型部署至預存程式 SQL Server 上的生產環境
- 修改 R 程式碼以將資料傳輸降至最低, 或移除成本高昂的資料轉換
- 啟用模型的自動化測試和重新定型

由於優化技術的選擇取決於您的應用程式或使用案例的關鍵工作, 案例研究會同時涵蓋一般的效能秘訣, 以及如何針對特定案例優化的指引, 也就是批次計分的優化。

+ **SQL Server 中的個別優化選項**

    在第一個效能案例研究中, 會使用單一模型類型, 在單一資料集上執行多個測試。 RevoscaleR 中的 rxLinMod 演算法是用來建立模型並從中建立分數, 但是程式碼和基礎資料資料表已有系統地改變, 以測試每項變更的影響。

    例如, 在一個測試回合中, R 程式碼已改變, 因此可以使用轉換函式, 在特徵工程之間進行比較, 與預先計算功能, 然後從資料表載入功能。 在另一個測試回合中, 使用標準索引資料表與資料表中具有各種壓縮類型或新索引類型的資料, 來比較模型定型效能。

+ **特定大量評分案例的優化**

    第二個案例研究中的機器學習工作牽涉到處理多個位置所提交的多個恢復, 並尋找每個工作位置的最佳候選項。 機器學習模型本身會被視為二元分類問題: 它會採用繼續和作業描述做為輸入, 並產生每個恢復作業配對的機率。 因為目標是要找出最符合的專案, 所以會使用使用者定義的機率臨界值來進一步篩選並只取得正確的相符專案。

    針對此解決方案, 主要目標是要在計分期間達到低延遲。 不過, 即使在評分程式期間, 這項工作也會耗費大量運算費用, 因為每個新的作業都必須在合理的時間範圍內, 與數百萬個繼續進行比對。 此外, 功能工程步驟也會針對每個恢復或作業產生超過2000的功能, 而且是顯著的效能瓶頸。

我們建議您查看第一個案例研究的所有結果, 以判斷哪些技術適用于您的解決方案, 並權衡其潛在的影響。

然後, 檢查評分優化案例研究的結果, 以瞭解作者如何套用不同的技術, 並將伺服器優化以支援特定的工作負載。

## <a name="performance-optimization-process"></a>效能優化程式

效能的設定和微調需要建立一個堅實基底, 針對特定工作負載設計的優化層:

- 選擇適當的伺服器來裝載分析。 通常會建議使用報表次要、資料倉儲或其他已用於其他報表或分析的伺服器。 不過, 在混合式交易分析處理 (HTAP) 解決方案中, 運算元據可用來做為 R 的輸入, 以快速計分。

- 設定 SQL Server 實例, 以在適當的層級平衡 database engine 作業和 R 或 Python 腳本的執行。 這可能包括變更記憶體和 CPU 使用量的 SQL Server 預設值、NUMA 和處理器親和性設定, 以及資源群組的建立。

- 優化伺服器電腦, 以支援有效率地使用外部腳本。 這可能包括增加用於外部腳本執行的帳戶數目、啟用封裝管理, 以及將使用者指派給相關的安全性角色。

- 在 SQL Server 中套用資料儲存和傳輸特有的優化, 包括編制索引和統計資料策略、查詢設計和查詢優化, 以及用於機器學習的資料表設計。 您也可以分析資料源和資料傳輸方法, 或修改 ETL 進程以優化功能解壓縮。

- 微調分析模型以避免效率不佳。 可能的優化範圍取決於您的 R 程式碼複雜度, 以及您所使用的封裝和資料。 主要工作包括消除成本高昂的資料轉換, 或將 R 或 Python 的資料準備或功能工程工作卸載至 ETL 進程或 SQL。 您也可以重構腳本、排除內嵌套件安裝、將 R 程式碼分成個別程式來進行定型、評分和評估, 或簡化程式碼以更有效率的方式使用預存程式。

## <a name="articles-in-this-series"></a>本系列文章

+ [SQL Server 中 R 的效能微調-硬體](../r/sql-server-configuration-r-services.md)

    提供設定安裝所在之硬體[!INCLUDE[ssNoVersion_md](../../includes/ssnoversion-md.md)]的指引, 以及設定 SQL Server 實例以更好的支援外部腳本。 它特別適用于**資料庫管理員**。

+ [SQL Server 程式碼和資料優化中 R 的效能微調](../r/r-and-data-optimization-r-services.md)

    提供如何優化外部腳本以避免已知問題的特定提示。 這對**資料科學家**最為有用。

    > [!NOTE]
    > 雖然本節中大部分的資訊都適用于 R 一般, 但某些資訊是 RevoScaleR 分析函式特有的。 **Revoscalepy**和其他支援的 Python 程式庫不提供詳細的效能指導方針。
    >

+ [SQL Server 方法和結果中 R 的效能微調](../r/performance-case-study-r-services.md)

    摘要說明兩個案例研究使用了哪些資料、如何測試效能, 以及優化對結果的影響。
